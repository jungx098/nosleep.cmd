#!/usr/bin/env sh

#==============================================================================
# nosleep for Cygwin
#==============================================================================

GREADLINK=readlink
GTIMEOUT=timeout
GEXPR=expr

#==============================================================================
# Check platform
#==============================================================================

PLATFORM=$($GEXPR substr $(uname -s) 1 9)

if [ "$PLATFORM" != "CYGWIN_NT" ]; then
    echo "NOT verified for '"${PLATFORM}"'"
    exit -1
fi

#==============================================================================
# Change working path to script path
#==============================================================================

OLD_PATH=$(pwd)
SCRIPT_PATH=$(dirname "$($GREADLINK -f -- "$0")")
cd "$SCRIPT_PATH"

#==============================================================================
# Set duration; default duration is 8 hours
#==============================================================================

DURATION=8h

if [ -n "$1" ]; then
    DURATION="$1"
fi

# Add s (sec) for integer input
if [ "$DURATION" -eq "$DURATION" ] 2>/dev/null; then
    DURATION="$DURATION""s"
fi

#==============================================================================
# Verify time unit
#==============================================================================

UNIT="${DURATION: -1}"

case $UNIT in
    [smhd] ) ;;
    *      ) echo "nosleep.sh: invalid time interval ‘""$DURATION""’"
             exit -1
             ;;
esac

#==============================================================================
# Relay ^C to timeout
#==============================================================================

trap 'kill -INT -$PID' INT

echo "No sleep for $DURATION (^C to exit)..."
echo "Start: $(date)"

#==============================================================================
# Main process
#==============================================================================

$GTIMEOUT $DURATION bash -c "while true; do ./wakeup.cmd; sleep 60; done" &

#==============================================================================
# Wait until timeout ends
#==============================================================================

# Set PID
PID=$!

# Wait until PID ends
wait $PID
echo "End:   $(date)"

#==============================================================================
# Restore working path
#==============================================================================

cd "$OLD_PATH"
